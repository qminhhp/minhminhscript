#!/bin/bash
# WP Minhminh Script - WordPress VPS Management Tool
# Version: 1.0.0
# Author: Minhminh
# Description: Qu·∫£n l√Ω nhi·ªÅu WordPress sites tr√™n VPS v·ªõi PHP-FPM pools ri√™ng bi·ªát

# Get script directory (resolve symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
    DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Load common functions
source "${SCRIPT_DIR}/lib/common.sh"

# Initialize
initialize

# Load modules
load_modules() {
    source "${MODULES_DIR}/site/site-manager.sh"
    source "${MODULES_DIR}/phpfpm/phpfpm-manager.sh"
    source "${MODULES_DIR}/nginx/nginx-manager.sh"
    source "${MODULES_DIR}/database/database-manager.sh"
    source "${MODULES_DIR}/backup/backup-manager.sh"
    source "${MODULES_DIR}/cache/cache-manager.sh"
    source "${MODULES_DIR}/monitor/monitor-manager.sh"
    source "${MODULES_DIR}/wordpress/wordpress-menu.sh"
    source "${MODULES_DIR}/domain/domain-menu.sh"
    source "${MODULES_DIR}/security/security-menu.sh"
    source "${MODULES_DIR}/migration/migration-menu.sh"
    source "${MODULES_DIR}/n8n/n8n-menu.sh"
    source "${MODULES_DIR}/update/update-manager.sh"
    source "${MODULES_DIR}/update/update-menu.sh"
}

# Main menu
show_main_menu() {
    show_header

    # Check for updates silently in background
    local current_version=$(get_current_version)
    local latest_version=$(get_latest_version 2>/dev/null)
    local update_available=false

    if [[ -n "$latest_version" ]] && version_gt "$current_version" "$latest_version" 2>/dev/null; then
        update_available=true
    fi

    # Show version info
    echo -e "${CYAN}WP Minhminh Script${NC} ${YELLOW}v${current_version}${NC}"

    if [[ "$update_available" == "true" ]]; then
        echo -e "${GREEN}üéâ C√≥ phi√™n b·∫£n m·ªõi: v${latest_version}${NC} - Ch·ªçn ${YELLOW}[12]${NC} ƒë·ªÉ c·∫≠p nh·∫≠t"
    fi

    echo ""
    echo -e "${CYAN}MENU CH√çNH${NC}"
    echo ""
    echo "  1. Qu·∫£n l√Ω Sites"
    echo "  2. Qu·∫£n l√Ω Database"
    echo "  3. Qu·∫£n l√Ω Cache"
    echo "  4. Backup & Restore"
    echo "  5. WordPress N√¢ng Cao"
    echo "  6. Qu·∫£n l√Ω Domains"
    echo "  7. B·∫£o M·∫≠t (Firewall, Fail2ban, Logrotate)"
    echo "  8. Gi√°m s√°t H·ªá th·ªëng"
    echo "  9. Chuy·ªÉn VPS & Sites (Migration)"
    echo " 10. C√†i ƒë·∫∑t & C·∫•u h√¨nh"
    echo " 11. n8n Workflow Automation"

    if [[ "$update_available" == "true" ]]; then
        echo -e " ${GREEN}12. üîÑ C·∫≠p nh·∫≠t Script${NC} ${YELLOW}(v${latest_version} c√≥ s·∫µn!)${NC}"
    else
        echo " 12. üîÑ Ki·ªÉm tra C·∫≠p nh·∫≠t"
    fi

    echo "  0. Tho√°t"
    echo ""
    show_footer
}

# Site management menu
show_site_menu() {
    while true; do
        show_header
        echo -e "${CYAN}QU·∫¢N L√ù SITES${NC}"
        echo ""
        echo "  1. Th√™m site m·ªõi"
        echo "  2. X√≥a site"
        echo "  3. Danh s√°ch sites"
        echo "  4. Th√¥ng tin site"
        echo "  5. C√†i ƒë·∫∑t SSL"
        echo "  6. Gia h·∫°n SSL"
        echo "  7. Enable/Disable site"
        echo "  0. Quay l·∫°i"
        echo ""
        show_footer

        read -p "Ch·ªçn ch·ª©c nƒÉng: " choice

        case $choice in
            1)
                add_site
                ;;
            2)
                remove_site
                ;;
            3)
                list_sites
                ;;
            4)
                show_site_info
                ;;
            5)
                read -p "Nh·∫≠p t√™n mi·ªÅn: " domain
                read -p "Nh·∫≠p site name: " site_name
                setup_ssl "$domain" "$site_name"
                pause
                ;;
            6)
                renew_ssl
                pause
                ;;
            7)
                echo ""
                read -p "Nh·∫≠p site name: " site_name
                echo "1. Enable site"
                echo "2. Disable site"
                read -p "Ch·ªçn: " action
                if [[ "$action" == "1" ]]; then
                    enable_nginx_site "$site_name"
                else
                    disable_nginx_site "$site_name"
                fi
                pause
                ;;
            0)
                break
                ;;
            *)
                print_error "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"
                pause
                ;;
        esac
    done
}

# Database management menu
show_database_menu() {
    while true; do
        show_header
        echo -e "${CYAN}QU·∫¢N L√ù DATABASE${NC}"
        echo ""
        echo "  1. Danh s√°ch databases"
        echo "  2. Backup database"
        echo "  3. Restore database"
        echo "  4. Optimize database"
        echo "  5. Cleanup WordPress database"
        echo "  6. Xem dung l∆∞·ª£ng database"
        echo "  0. Quay l·∫°i"
        echo ""
        show_footer

        read -p "Ch·ªçn ch·ª©c nƒÉng: " choice

        case $choice in
            1)
                list_databases
                ;;
            2)
                read -p "Nh·∫≠p t√™n database: " db_name
                backup_database "$db_name"
                pause
                ;;
            3)
                read -p "Nh·∫≠p t√™n database: " db_name
                read -p "Nh·∫≠p ƒë∆∞·ªùng d·∫´n file backup: " backup_file
                restore_database "$db_name" "$backup_file"
                pause
                ;;
            4)
                read -p "Nh·∫≠p t√™n database: " db_name
                optimize_database "$db_name"
                pause
                ;;
            5)
                read -p "Nh·∫≠p t√™n database: " db_name
                read -p "Nh·∫≠p table prefix (m·∫∑c ƒë·ªãnh: wp_): " db_prefix
                db_prefix=${db_prefix:-wp_}
                cleanup_wordpress_db "$db_name" "$db_prefix"
                pause
                ;;
            6)
                read -p "Nh·∫≠p t√™n database: " db_name
                echo "Dung l∆∞·ª£ng: $(get_database_size "$db_name")"
                pause
                ;;
            0)
                break
                ;;
            *)
                print_error "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"
                pause
                ;;
        esac
    done
}

# Cache management menu
show_cache_menu() {
    while true; do
        show_header
        echo -e "${CYAN}QU·∫¢N L√ù CACHE${NC}"
        echo ""
        echo "  1. X√≥a cache m·ªôt site"
        echo "  2. X√≥a cache t·∫•t c·∫£ sites"
        echo "  3. Tr·∫°ng th√°i cache"
        echo "  4. Enable/Disable OPcache"
        echo "  5. C√†i ƒë·∫∑t Redis"
        echo "  6. C√†i ƒë·∫∑t Memcached"
        echo "  0. Quay l·∫°i"
        echo ""
        show_footer

        read -p "Ch·ªçn ch·ª©c nƒÉng: " choice

        case $choice in
            1)
                read -p "Nh·∫≠p t√™n mi·ªÅn: " domain
                clear_site_cache "$domain"
                pause
                ;;
            2)
                clear_all_cache
                ;;
            3)
                get_cache_status
                ;;
            4)
                echo "1. Enable OPcache"
                echo "2. Disable OPcache"
                read -p "Ch·ªçn: " action
                if [[ "$action" == "1" ]]; then
                    enable_opcache
                else
                    disable_opcache
                fi
                pause
                ;;
            5)
                echo "1. C√†i ƒë·∫∑t Redis"
                echo "2. G·ª° c√†i ƒë·∫∑t Redis"
                read -p "Ch·ªçn: " action
                if [[ "$action" == "1" ]]; then
                    install_redis
                else
                    uninstall_redis
                fi
                pause
                ;;
            6)
                echo "1. C√†i ƒë·∫∑t Memcached"
                echo "2. G·ª° c√†i ƒë·∫∑t Memcached"
                read -p "Ch·ªçn: " action
                if [[ "$action" == "1" ]]; then
                    install_memcached
                else
                    uninstall_memcached
                fi
                pause
                ;;
            0)
                break
                ;;
            *)
                print_error "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"
                pause
                ;;
        esac
    done
}

# Backup menu
show_backup_menu() {
    while true; do
        show_header
        echo -e "${CYAN}BACKUP & RESTORE${NC}"
        echo ""
        echo "  1. Backup m·ªôt site"
        echo "  2. Backup t·∫•t c·∫£ sites"
        echo "  3. Restore site"
        echo "  4. Danh s√°ch backups"
        echo "  5. X√≥a backups c≈©"
        echo "  6. C√†i ƒë·∫∑t auto backup"
        echo "  0. Quay l·∫°i"
        echo ""
        show_footer

        read -p "Ch·ªçn ch·ª©c nƒÉng: " choice

        case $choice in
            1)
                read -p "Nh·∫≠p t√™n mi·ªÅn: " domain
                backup_site "$domain"
                pause
                ;;
            2)
                auto_backup_all
                ;;
            3)
                read -p "Nh·∫≠p ƒë∆∞·ªùng d·∫´n backup: " backup_dir
                restore_site "$backup_dir"
                pause
                ;;
            4)
                list_backups
                ;;
            5)
                read -p "X√≥a backups c≈© h∆°n (ng√†y, m·∫∑c ƒë·ªãnh 7): " days
                days=${days:-7}
                cleanup_old_backups "$days"
                pause
                ;;
            6)
                echo "1. Daily (h√†ng ng√†y)"
                echo "2. Weekly (h√†ng tu·∫ßn)"
                echo "3. Monthly (h√†ng th√°ng)"
                echo "4. X√≥a auto backup"
                read -p "Ch·ªçn: " schedule_choice
                case $schedule_choice in
                    1) setup_auto_backup_cron "daily" ;;
                    2) setup_auto_backup_cron "weekly" ;;
                    3) setup_auto_backup_cron "monthly" ;;
                    4) remove_auto_backup_cron ;;
                esac
                pause
                ;;
            0)
                break
                ;;
            *)
                print_error "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"
                pause
                ;;
        esac
    done
}

# Monitoring menu
show_monitoring_menu() {
    while true; do
        show_header
        echo -e "${CYAN}GI√ÅM S√ÅT H·ªÜ TH·ªêNG${NC}"
        echo ""
        echo "  1. T√†i nguy√™n h·ªá th·ªëng"
        echo "  2. Tr·∫°ng th√°i d·ªãch v·ª•"
        echo "  3. PHP-FPM pools"
        echo "  4. Dung l∆∞·ª£ng sites"
        echo "  5. Dung l∆∞·ª£ng databases"
        echo "  6. Tr·∫°ng th√°i websites"
        echo "  7. Th√¥ng tin h·ªá th·ªëng"
        echo "  8. T·∫°o b√°o c√°o"
        echo "  9. Gi√°m s√°t real-time"
        echo "  0. Quay l·∫°i"
        echo ""
        show_footer

        read -p "Ch·ªçn ch·ª©c nƒÉng: " choice

        case $choice in
            1) check_system_resources ;;
            2) check_services ;;
            3) monitor_phpfpm_pools ;;
            4) monitor_disk_usage ;;
            5) monitor_database_sizes ;;
            6) monitor_all_websites ;;
            7) get_system_info ;;
            8)
                generate_status_report
                pause
                ;;
            9) realtime_monitor ;;
            0) break ;;
            *)
                print_error "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"
                pause
                ;;
        esac
    done
}

# Settings menu
show_settings_menu() {
    while true; do
        show_header
        echo -e "${CYAN}C√ÄI ƒê·∫∂T & C·∫§U H√åNH${NC}"
        echo ""
        echo "  1. Ki·ªÉm tra y√™u c·∫ßu h·ªá th·ªëng"
        echo "  2. Test Nginx configuration"
        echo "  3. C·∫•u h√¨nh login rate limiting"
        echo "  4. Xem logs"
        echo "  5. V·ªÅ script"
        echo "  0. Quay l·∫°i"
        echo ""
        show_footer

        read -p "Ch·ªçn ch·ª©c nƒÉng: " choice

        case $choice in
            1)
                check_requirements
                pause
                ;;
            2)
                test_nginx_config
                ;;
            3)
                enable_login_rate_limit
                pause
                ;;
            4)
                if [[ -f "$LOG_FILE" ]]; then
                    tail -n 50 "$LOG_FILE"
                else
                    print_warning "Ch∆∞a c√≥ log"
                fi
                pause
                ;;
            5)
                show_header
                echo -e "${CYAN}V·ªÄ SCRIPT${NC}"
                echo ""
                echo "WP Minhminh Script - WordPress VPS Management Tool"
                echo "Version: 1.0.0"
                echo ""
                echo "T√≠nh nƒÉng ch√≠nh:"
                echo "  ‚Ä¢ Qu·∫£n l√Ω nhi·ªÅu WordPress sites"
                echo "  ‚Ä¢ PHP-FPM pool ri√™ng bi·ªát cho m·ªói site (b·∫£o m·∫≠t)"
                echo "  ‚Ä¢ Nginx vhost t·ª± ƒë·ªông"
                echo "  ‚Ä¢ Backup & Restore"
                echo "  ‚Ä¢ Cache management"
                echo "  ‚Ä¢ Database management"
                echo "  ‚Ä¢ System monitoring"
                echo ""
                echo "Tham kh·∫£o t·ª´:"
                echo "  ‚Ä¢ Trellis (Roots.io)"
                echo "  ‚Ä¢ WP Tang Toc OLS"
                echo ""
                show_footer
                pause
                ;;
            0)
                break
                ;;
            *)
                print_error "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"
                pause
                ;;
        esac
    done
}

# Main function
main() {
    # Check if running as root
    check_root

    # Load all modules
    load_modules

    # Main loop
    while true; do
        show_main_menu
        read -p "Ch·ªçn ch·ª©c nƒÉng: " choice

        case $choice in
            1) show_site_menu ;;
            2) show_database_menu ;;
            3) show_cache_menu ;;
            4) show_backup_menu ;;
            5) wordpress_advanced_menu ;;
            6) domain_management_menu ;;
            7) security_management_menu ;;
            8) show_monitoring_menu ;;
            9) migration_management_menu ;;
            10) show_settings_menu ;;
            11) n8n_management_menu ;;
            12) show_update_menu ;;
            0)
                print_info "T·∫°m bi·ªát!"
                exit 0
                ;;
            *)
                print_error "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"
                pause
                ;;
        esac
    done
}

# Handle command line arguments
if [[ $# -gt 0 ]]; then
    load_modules
    case "$1" in
        "add-site")
            add_site
            ;;
        "remove-site")
            remove_site
            ;;
        "list-sites")
            list_sites
            ;;
        "backup-all-auto")
            auto_backup_all
            ;;
        "import-site")
            import_site_from_package "$2"
            ;;
        "export-site")
            if [[ -n "$2" ]]; then
                prepare_site_export "$2"
            else
                print_error "C·∫ßn ch·ªâ ƒë·ªãnh t√™n mi·ªÅn"
                echo "Usage: wpminhminhscript export-site <domain>"
                exit 1
            fi
            ;;
        "update")
            do_update "${2:-main}"
            ;;
        "check-update")
            check_for_updates false
            ;;
        "version")
            echo "WP Minhminh Script v$(get_current_version)"
            ;;
        "help")
            echo "WP Minhminh Script - WordPress VPS Management Tool"
            echo ""
            echo "Usage: wpminhminhscript [command] [arguments]"
            echo ""
            echo "Commands:"
            echo "  add-site                    Th√™m site m·ªõi"
            echo "  remove-site                 X√≥a site"
            echo "  list-sites                  Danh s√°ch sites"
            echo "  backup-all-auto             Backup t·∫•t c·∫£ sites (cho cron)"
            echo "  import-site <path>          Import site t·ª´ migration package"
            echo "  export-site <domain>        Export site th√†nh migration package"
            echo "  update [branch]             C·∫≠p nh·∫≠t script (m·∫∑c ƒë·ªãnh: main)"
            echo "  check-update                Ki·ªÉm tra phi√™n b·∫£n m·ªõi"
            echo "  version                     Hi·ªÉn th·ªã phi√™n b·∫£n hi·ªán t·∫°i"
            echo "  help                        Hi·ªÉn th·ªã tr·ª£ gi√∫p"
            echo ""
            echo "Examples:"
            echo "  wpminhminhscript                    # M·ªü menu t∆∞∆°ng t√°c"
            echo "  wpminhminhscript version            # Xem phi√™n b·∫£n"
            echo "  wpminhminhscript check-update       # Ki·ªÉm tra update"
            echo "  wpminhminhscript update             # C·∫≠p nh·∫≠t l√™n phi√™n b·∫£n m·ªõi"
            echo "  wpminhminhscript export-site abc.com # Export site"
            echo ""
            ;;
        *)
            print_error "L·ªánh kh√¥ng h·ª£p l·ªá: $1"
            echo "Ch·∫°y 'wpminhminhscript help' ƒë·ªÉ xem danh s√°ch l·ªánh"
            exit 1
            ;;
    esac
else
    # Run interactive menu
    main
fi
